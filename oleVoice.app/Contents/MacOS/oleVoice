#!/bin/bash
# oleVoice 单实例启动器

APP_DIR="$(cd "$(dirname "$0")/.." && pwd)"
PID_FILE="/tmp/olevoice.pid"

# 检查是否已有实例在运行
check_running() {
    if [ -f "$PID_FILE" ]; then
        local old_pid=$(cat "$PID_FILE" 2>/dev/null)
        if [ -n "$old_pid" ] && kill -0 "$old_pid" 2>/dev/null; then
            # 检查是否是 oleVoice 进程
            if ps -p "$old_pid" -o comm= | grep -q "VoiceInputSwift"; then
                echo "oleVoice 已经在运行 (PID: $old_pid)"
                return 0
            fi
        fi
    fi
    return 1
}

# 主逻辑
if check_running; then
    osascript -e 'display notification "oleVoice 已经在运行" with title "oleVoice"'
    exit 0
fi

# 清理旧PID文件
rm -f "$PID_FILE"

# 启动 Swift 主程序 (Swift内部会管理ASR服务)
"$APP_DIR/MacOS/VoiceInputSwift" &
SWIFT_PID=$!
echo $SWIFT_PID > "$PID_FILE"

# 等待 Swift 程序退出
wait $SWIFT_PID

# 清理 PID 文件
rm -f "$PID_FILE"

exit 0
